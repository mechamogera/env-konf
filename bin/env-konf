#! /usr/bin/env ruby
# vim:ft=ruby:
# ruby -Ilib bin/cipher-conf

require 'optparse'
require 'env-konf'
require 'highline'

class EnvKonfCommand
  VERSION = EnvKonf::VERSION
  NAME = "env-konf"

  def self.run(argv)
    new(argv.dup).run
  end

  def initialize(argv)
    @options = {}
    @argv = argv

    @subparsers = {
       "help" => OptionParser.new { |opt|
          opt.banner = <<-EOB
Usage: #{NAME} help <subcommand>

Show help of subcommand.
          EOB
       },
       "zip" => OptionParser.new { |opt|
          opt.banner = <<-EOB
Usage: #{NAME} zip <zippath>

Encode current profile to <zippath>
          EOB

          opt.separator ""

          opt.separator "Options:"
          opt.on("-p", "--password=VAL", "Specify encoding password") { |v| @options[:password] = v }
          opt.on("--profile=VAL", "Specify profile") { |v| @options[:profile] = v }
          opt.on("-f", "--force", "Zip forced") { @options[:force] = true }
       },
       "unzip" => OptionParser.new { |opt|
          opt.banner = <<-EOB
Usage: #{NAME} unzip <zippath>

Decode from <zippath> to pit directory
          EOB

          opt.separator ""

          opt.separator "Options:"
          opt.on("-p", "--password=VAL", "Specify decoding password") { |v| @options[:password] = v }
          opt.on("-f", "--force", "Zip forced") { @options[:force] = true }
       },
       "zip-config" => OptionParser.new { |opt|
         opt.banner = <<-EOB
Usage: #{NAME} zip-config

Set configuration options
         EOB

         opt.separator ""

         opt.separator "Options:"
         opt.on("-p", "--encode-password=VAL", "Set password hash for checing password of encoding") { |v| @options[:check_password] = v }
         opt.on("-r", "--profile=VAL",  "Set profile") { |v| @options[:profile] = v }
         opt.on("-z", "--zip-path=VAL", "Set zippath") { |v| @options[:zip_path] = v }
       },
       "profile-init" => OptionParser.new { |opt|
         opt.banner = <<-EOB
Usage: #{NAME} profile-init <profile>

create <profile>
         EOB
       },
    }

    @parser = OptionParser.new do |parser|
      parser.banner = <<-EOB
Usage: #{NAME} <subcommand> <args>
      EOB

      parser.separator ""

      parser.separator "Subcommands:"
      @subparsers.keys.sort.each do |k|
        parser.separator "#{parser.summary_indent}    #{k}"
      end

      parser.separator ""

      parser.separator "Options:"
      parser.on('--version', "Show version string `#{VERSION}'") do
        puts VERSION
        exit
      end
    end
  end

  def run
    @parser.order!(@argv)
    if @argv.empty?
      puts @parser.help
      exit
    end

    @subcommand = @argv.shift
    method_name = "cmd_#{@subcommand.gsub("-", "_")}"
    unless self.respond_to?(method_name)
      raise ArgumentError.new("Not implemented subcommand: `#{@subcommand}'.")
    end
    
    @subparsers[@subcommand].parse!(@argv)
    self.send(method_name)
  end

  def cmd_help
    subcommand, = @argv
    if subcommand
      if @subparsers.key?(subcommand)
        puts @subparsers[subcommand].help
      else
        puts <<-EOB
No such subcommand `#{subcommand}'
#{@parser.help}
        EOB
      end
    else
      puts @parser.help
    end
  end

  def cmd_zip
    path, = @argv
    @options[:path] = path
    EnvKonf.zip(@options)
  end

  def cmd_unzip
    path, = @argv
    @options[:path] = path
    EnvKonf.unzip(@options)
  end

  def cmd_zip_config
    EnvKonf::Config.passwd_md5 = @options[:check_password] if @options[:check_password]
    EnvKonf::Config.zip_path = @options[:zip_path] if @options[:zip_path]
    EnvKonf::Config.profile = @options[:profile] if @options[:profile]
  end

  def cmd_profile_init
    profile, = @argv
    path = EnvKonf.profile_init(profile)
    puts "  create #{path}"
  end
end

EnvKonfCommand.run(ARGV)
